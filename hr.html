<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Generator</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <button type="button" onclick="generateEmployee()">
      Generate Employee
    </button>
    <div id="result"></div>
    <script src="https://chancejs.com/chance.min.js"></script>
    <script>
      const chance = new Chance()

      /**
       * @typedef {Object} JobFlowNode
       * @property {string} label
       * @property {number[]} choices
       * @property {number[]} probabilities
       * @property {string[]} [actions]
       * @property {string[]} [reasons]
       * @property {number[]} [minYears]
       * @property {number[]} [maxYears]
       */
      const nodes /** @type {JobFlowNode} */ = [
        /* 0 */ {
          label: 'Start',
          choices: [1, 2, 3],
          probabilities: [0.2, 0.5, 0.3],
          actions: ['Hire', 'Hire', 'Hire'],
          reasons: ['Internship', 'Permanent', 'Contractual']
        },
        /* 1 */ {
          label: 'Internship',
          choices: [2, 9, 10],
          probabilities: [0.6, 0.3, 0.1],
          actions: ['Hire', 'Discontinuance'],
          reasons: ['Internship Conversion', 'Internship End'],
          minYears: [0.5, 0.5],
          maxYears: [0.5, 0.5, 0.5]
        },
        /* 2 */ {
          label: 'Permanent',
          choices: [4, 7, 9, 10],
          probabilities: [0.2, 0.2, 0.2, 0.4],
          minYears: [3],
          maxYears: [5, 2]
        },
        /* 3 */ {
          label: 'Contractual',
          choices: [2, 3, 9, 10],
          probabilities: [0.1, 0.4, 0.3, 0.2],
          actions: ['Hire', 'Hire', 'Discontinuance'],
          reasons: ['Transition to Permanent', 'Recontract', 'Contract End'],
          minYears: [1, 1, 1],
          maxYears: [2, 2, 2, 2]
        },
        /* 4 */ {
          label: 'Promotion',
          choices: [5, 8, 9, 10],
          probabilities: [0.2, 0.1, 0.2, 0.5],
          minYears: [5],
          maxYears: [8, 2]
        },
        /* 5 */ {
          label: 'Promotion',
          choices: [6, 9, 10],
          probabilities: [0.1, 0.2, 0.7],
          minYears: [5],
          maxYears: [8]
        },
        /* 6 */ {
          label: 'Promotion',
          choices: [9, 10],
          probabilities: [0.3, 0.7],
          minYears: [5]
        },
        /* 7 */ {
          label: 'Transfer',
          choices: [4, 8, 9, 10],
          probabilities: [0.2, 0.1, 0.2, 0.5],
          minYears: [3],
          maxYears: [5, 2]
        },
        /* 8 */ {
          label: 'Transfer',
          choices: [6, 9, 10],
          probabilities: [0.1, 0.5, 0.4],
          minYears: [5],
          maxYears: [8]
        },
        /* 9 */ {
          label: 'Discontinuance',
          choices: [10],
          probabilities: [1]
        },
        /* _ */ { label: 'Current' }
      ]

      const ageBoundaries = [21, 26, 31, 41, 51].reverse()
      const ageCategories = [
        '21-25',
        '26-30',
        '31-40',
        '41-50',
        '51-60'
      ].reverse()
      const ageProbabilities = [0.1, 0.4, 0.2, 0.2, 0.1].reverse()

      generateEmployee()

      function generateEmployee() {
        const data = []

        const name = chance.name({
          middle: Math.random() > 0.5,
          nationality: 'en'
        })
        const jobFlow = generateJobFlow()

        if (jobFlow[0].label === 'Internship') {
          ageCategories.length = ageProbabilities.length = 2
          ageProbabilities[0] = ageProbabilities[1] = 0.5
        }
        const ageCategory = choose(ageCategories, ageProbabilities)
        const ageLimitMin = +ageCategory.split('-')[0]
        const ageLimitMax = +ageCategory.split('-')[1]
        let age = Math.floor(
          Math.random() * (ageLimitMax - ageLimitMin + 1) + ageLimitMin
        )
        const gender = choose(['Male', 'Female'])

        let { division, businessUnit, department } = generateUnit({})
        let { country, province, city } = generateLocation({})
        let workingTime = 'Full-time'
        let union = 'No'
        let salary = choose(['Bi-weekly', 'Monthly'])

        let jobLevel = choose([
          'Internship',
          'Entry',
          'Mid',
          'Senior',
          'Manager'
        ])

        for (let j = 0; j < jobFlow.length; ++j) {
          const { label, date, action, reason } = jobFlow[j]
          const entry = { name, gender, age }
          data.push(entry)

          entry.date = new Date(date).toLocaleDateString()
          entry.actionName = action
          entry.actionReason = reason

          entry.ageCategory = ageCategories.find(
            (_, i) => age >= ageBoundaries[i]
          )
          age += Math.floor(
            ((jobFlow[j + 1]?.date || Date.now()) - date) / 31536e6
          )

          if (label === 'Transfer') {
            const changes = generateTransfer({
              division,
              businessUnit,
              department,
              country,
              province,
              city
            })
            entry.actionReason = changes.actionReason
            division = changes.division
            businessUnit = changes.businessUnit
            department = changes.department
            country = changes.country
            province = changes.province
            city = changes.city
          }
          entry.division = division
          entry.businessUnit = businessUnit
          entry.department = department
          entry.country = country
          entry.province = province
          entry.city = city

          if (label === 'Contractual') {
            workingTime = choose(['Full-time', 'Part-time'])
            salary = choose(['Hourly', 'Bi-weekly', 'Monthly'])
          }
          if (label === 'Permanent') union = choose(['Yes', 'No'], [0.9, 0.1])

          if (reason === 'Internship Conversion') jobLevel = 'Entry'
          if (label === 'Internship') jobLevel = 'Internship'
          if (label === 'Promotion') {
            const levels = ['Entry', 'Mid', 'Senior', 'Manager']
            const index = levels.indexOf(jobLevel)
            jobLevel = levels[index + 1]
          }

          entry.workingTime = workingTime
          entry.salary = salary
          entry.union = union
          entry.jobLevel = jobLevel
        }

        document.getElementById('result').innerHTML = ''
        const table = buildHtmlTable(data)
        document.getElementById('result').appendChild(table)
      }

      function generateTransfer({
        division,
        businessUnit,
        department,
        country,
        province,
        city
      }) {
        const target = choose(
          [
            'division',
            'business unit',
            'department',
            'city',
            'province',
            'country'
          ],
          [0.2, 0.2, 0.05, 0.3, 0.2, 0.05]
        )
        const actionReason = 'Change of ' + target

        switcher(target, {
          'division': [
            () => ({ division, businessUnit } = generateUnit({ department }))
          ],
          'business unit': [
            () => ({ businessUnit } = generateUnit({ division, department }))
          ],
          'department': [
            () => ({ department } = generateUnit({ division, businessUnit }))
          ],
          'city': [() => ({ city } = generateLocation({ country, province }))],
          'province': [
            () => ({ province, city } = generateLocation({ country }))
          ],
          'country': [
            () => ({ country, province, city } = generateLocation({}))
          ]
        })()

        return {
          actionReason,
          division,
          businessUnit,
          department,
          country,
          province,
          city
        }
      }

      function generateUnit({ division, businessUnit, department }) {
        division ||= choose(
          [
            'Agriculture',
            'Construction',
            'Consumer Products',
            'Food',
            'Forestry',
            'Retail',
            'Shipbuilding',
            'Transportation'
          ],
          [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.3]
        )

        businessUnit ||= switcher(division, {
          'Agriculture': ['Cavendish Agri', 'Juniper'],
          'Construction': ['Wallboard', 'CFM', 'Gulf', 'Kent Homes', 'Pumps'],
          'Consumer Products': ['Tissue', 'Personal Care'],
          'Food': ['Cavendish'],
          'Forestry': ['Woodlands', 'Pulp & Paper', 'Lake Utopia', 'Lumber'],
          'Retail': [
            [
              'Chandler',
              'Kent',
              'Truck & Trailer',
              'Plasticraft',
              'Atlas',
              'ICS'
            ]
          ],
          'Shipbuilding': ['JDI Shipbuilding'],
          'Transportation': [
            'Midland',
            'RST',
            'Sunbury',
            'NBM',
            'Kent Line',
            'JDI Logistics',
            'Habour Development'
          ]
        })

        department ||= choose([
          'Corporate',
          'HR',
          'Finance',
          'Health & Safety',
          'Supply chain',
          'IT',
          'Sales',
          'Marketing'
        ])

        return { division, businessUnit, department }
      }

      function generateLocation({ country, province, city }) {
        country ||= choose(['Canada', 'US'])

        province ||= switcher(country, {
          'Canada': [
            ['New Brunswick', 'Nova Scotia', 'Ontario', 'Prince Edward Island']
          ],
          'US': ['Maine', 'New York', 'Georgia', 'California']
        })

        city ||= switcher(province, {
          'New Brunswick': [
            [
              'Moncton',
              'Saint John',
              'Fredericton',
              'Halifax',
              'Sussex',
              'Utopia'
            ],
            [0.2, 0.3, 0.2, 0.1, 0.1, 0.1]
          ],
          'Nova Scotia': ['Vanghan'],
          'Ontario': ['Toronto'],
          'Prince Edward Island': ['Charlottetown'],
          'Maine': ['Portland'],
          'New York': ['New York City'],
          'Georgia': ['Atlanta'],
          'California': ['Los Angeles', 'San Francisco']
        })

        return { country, province, city }
      }

      function generateJobFlow() {
        const LIMIT = 20
        const path = [{ label: 'Start', index: 0 }]
        while (path[0].label === 'Start') {
          path.length = 1
          for (let k = 0; k < LIMIT; ++k) {
            const { choices, probabilities } = nodes[path.at(-1).index]
            const index = choose(choices, probabilities)
            const label = nodes[index].label
            path.push({ label, index })
            if (label === 'Current') break
          }
          if (path.at(-1).label !== 'Current') continue
          let date = Date.now()
          for (let j = path.length - 1; j > 0; --j) {
            path[j].date = date

            const prev = nodes[path[j - 1].index]
            const index = prev.choices.indexOf(path[j].index)
            const minYears = prev.minYears?.[index] || 0
            const maxYears = prev.maxYears?.[index] || 5
            const min = 31536e6 * minYears
            const max = 31536e6 * maxYears
            date -= chance.integer({ min, max })

            path[j].action = prev.actions?.[index] || path[j].label
            path[j].reason = prev.reasons?.[index] || ''
            if (path[j].action === 'Discontinuance' && !path[j].reason) {
              path[j].reason = choose(['Terminate', 'Resignation'])
            }

            delete path[j].index
          }
          path.shift(), path.pop()
          return path
        }
      }

      function choose(choices, probabilities) {
        probabilities ||= [...choices].fill(1 / choices.length)
        let sum = probabilities.reduce((a, b) => a + b)
        let random = Math.random() * sum
        for (let i = 0; i < choices.length; ++i) {
          if (random < probabilities[i]) return choices[i]
          random -= probabilities[i]
        }
      }

      function switcher(group, groups, defaultValue) {
        if (!groups.hasOwnProperty(group)) return defaultValue
        const [choices, probabilities] = Array.isArray(groups[group][0])
          ? groups[group]
          : [groups[group]]
        return choose(choices, probabilities)
      }

      function buildHtmlTable(df) {
        const table = document.createElement('table')
        for (const key in df[0]) {
          const tr = document.createElement('tr')
          const th = document.createElement('th')
          th.textContent = key
          tr.appendChild(th)
          df.forEach((row) => {
            const td = document.createElement('td')
            td.textContent = row[key]
            tr.appendChild(td)
          })
          table.appendChild(tr)
        }
        return table
      }
    </script>
  </body>
</html>
